<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Certificate Management - Admin Panel</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --navy: #0b3d91;
      --yellow: #ffd100;
      --dark: #0b2140;
      --light: #f2f4f8;
      --white: #fff;
      --gray: #6c757d;
    }

    body {
      font-family: 'Roboto', Arial, sans-serif;
      background: var(--light);
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: linear-gradient(135deg, var(--navy) 0%, var(--dark) 100%);
      color: var(--white);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    header h1 {
      font-size: 28px;
      margin-bottom: 5px;
    }

    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }

    .nav-tabs button {
      background: none;
      border: none;
      padding: 12px 20px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .nav-tabs button.active {
      color: var(--navy);
      border-bottom-color: var(--navy);
    }

    .tab-content {
      display: none;
      background: var(--white);
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .tab-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--navy);
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: inherit;
      font-size: 14px;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-primary {
      background: var(--navy);
      color: var(--white);
    }

    .btn-primary:hover {
      background: var(--dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(11, 61, 145, 0.3);
    }

    .btn-secondary {
      background: #6c757d;
      color: var(--white);
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-danger {
      background: #dc3545;
      color: var(--white);
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-success {
      background: #28a745;
      color: var(--white);
    }

    .btn-success:hover {
      background: #218838;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    table thead {
      background: var(--light);
      border-bottom: 2px solid #ddd;
    }

    table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: var(--navy);
    }

    table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }

    table tr:hover {
      background: #f9f9f9;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-success {
      background: #d4edda;
      color: #155724;
    }

    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }

    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }

    .alert {
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: none;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--white);
      padding: 30px;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #eee;
    }

    .modal-header h2 {
      font-size: 20px;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }

    .loader {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .loader.active {
      display: block;
    }

    .spinner {
      border: 4px solid var(--light);
      border-top: 4px solid var(--navy);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--white);
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid var(--navy);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .stat-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
      text-transform: uppercase;
    }

    .stat-card .number {
      font-size: 32px;
      font-weight: bold;
      color: var(--navy);
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }

      .stats {
        grid-template-columns: repeat(2, 1fr);
      }

      .nav-tabs {
        overflow-x: auto;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header>
      <h1><i class="fas fa-certificate"></i> Certificate Management System</h1>
      <p>Manage certificates, users, and verification</p>
      <button onclick="logout()" style="background: var(--yellow); color: var(--navy); border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px;">Logout</button>
    </header>

    <!-- Alert Messages -->
    <div id="alert" class="alert"></div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
      <button class="tab-btn" onclick="switchTab('generate')">Generate Certificate</button>
      <button class="tab-btn" onclick="switchTab('certificates')">View Certificates</button>
      <button class="tab-btn" onclick="switchTab('users')">Manage Users</button>
      <button class="tab-btn" onclick="switchTab('verify')">Verify Certificate</button>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content active">
      <h2><i class="fas fa-chart-line"></i> Dashboard</h2>
      <div class="stats" id="stats">
        <div class="stat-card">
          <h3>Total Certificates</h3>
          <div class="number" id="totalCerts">0</div>
        </div>
        <div class="stat-card">
          <h3>Active Certificates</h3>
          <div class="number" id="activeCerts">0</div>
        </div>
        <div class="stat-card">
          <h3>Total Users</h3>
          <div class="number" id="totalUsers">0</div>
        </div>
        <div class="stat-card">
          <h3>Revoked Certificates</h3>
          <div class="number" id="revokedCerts">0</div>
        </div>
      </div>
    </div>

    <!-- Generate Certificate Tab -->
    <div id="generate" class="tab-content">
      <h2><i class="fas fa-plus-circle"></i> Generate & Send Certificate</h2>
      <form onsubmit="generateCertificate(event)">
        <div class="form-row">
          <div class="form-group">
            <label for="fullName">Full Name *</label>
            <input type="text" id="fullName" required>
          </div>
          <div class="form-group">
            <label for="email">Email *</label>
            <input type="email" id="email" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="courseName">Course Name *</label>
            <input type="text" id="courseName" required>
          </div>
          <div class="form-group">
            <label for="certificateNumber">Certificate Number *</label>
            <input type="text" id="certificateNumber" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="courseSubtitle">Course Subtitle</label>
            <input type="text" id="courseSubtitle">
          </div>
          <div class="form-group">
            <label for="issueDate">Issue Date</label>
            <input type="date" id="issueDate">
          </div>
        </div>

        <div class="form-group">
          <label for="instructorName">Instructor Name</label>
          <input type="text" id="instructorName">
        </div>

        <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Generate & Send</button>
      </form>
    </div>

    <!-- View Certificates Tab -->
    <div id="certificates" class="tab-content">
      <h2><i class="fas fa-list"></i> All Certificates</h2>
      <div class="loader" id="loader">
        <div class="spinner"></div>
      </div>
      <table id="certificatesTable">
        <thead>
          <tr>
            <th>Certificate #</th>
            <th>Name</th>
            <th>Course</th>
            <th>Issue Date</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="certificatesList"></tbody>
      </table>
    </div>

    <!-- Manage Users Tab -->
    <div id="users" class="tab-content">
      <h2><i class="fas fa-users"></i> Manage Users</h2>
      <div class="loader" id="usersLoader">
        <div class="spinner"></div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Course</th>
            <th>Registered</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="usersList"></tbody>
      </table>
    </div>

    <!-- Verify Certificate Tab -->
    <div id="verify" class="tab-content">
      <h2><i class="fas fa-search"></i> Verify Certificate</h2>
      <div class="form-group">
        <label for="verifyCertNumber">Certificate Number *</label>
        <input type="text" id="verifyCertNumber" placeholder="Enter certificate number">
      </div>
      <button onclick="verifyCertificate()" class="btn btn-primary"><i class="fas fa-check"></i> Verify</button>
      <div id="verifyResult"></div>
    </div>
  </div>

  <!-- Revoke Modal -->
  <div id="revokeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Revoke Certificate</h2>
        <button class="close-btn" onclick="closeModal('revokeModal')">&times;</button>
      </div>
      <div class="form-group">
        <label for="revokeReason">Reason for Revocation</label>
        <textarea id="revokeReason"></textarea>
      </div>
      <button onclick="confirmRevoke()" class="btn btn-danger"><i class="fas fa-trash"></i> Revoke</button>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:5000/api';
    let currentCertToRevoke = null;
    let token = localStorage.getItem('adminToken');

    // Check authentication
    if (!token) {
      token = prompt('Enter admin token to continue:');
      if (!token) {
        alert('Authentication required');
        window.location.href = '/admin/login.php';
      } else {
        localStorage.setItem('adminToken', token);
      }
    }

    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

      // Show selected tab
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');

      if (tabName === 'dashboard') {
        loadDashboard();
      } else if (tabName === 'certificates') {
        loadCertificates();
      } else if (tabName === 'users') {
        loadUsers();
      }
    }

    function showAlert(message, type = 'success') {
      const alert = document.getElementById('alert');
      alert.textContent = message;
      alert.className = `alert alert-${type}`;
      setTimeout(() => {
        alert.style.display = 'none';
      }, 5000);
    }

    async function generateCertificate(e) {
      e.preventDefault();

      const data = {
        fullName: document.getElementById('fullName').value,
        email: document.getElementById('email').value,
        courseName: document.getElementById('courseName').value,
        courseSubtitle: document.getElementById('courseSubtitle').value,
        certificateNumber: document.getElementById('certificateNumber').value,
        issueDate: document.getElementById('issueDate').value,
        instructorName: document.getElementById('instructorName').value
      };

      try {
        const response = await fetch(`${API_BASE_URL}/certificates/admin/send`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
          showAlert('✅ Certificate generated and sent successfully!', 'success');
          e.target.reset();
        } else {
          showAlert('❌ ' + (result.error || 'Error generating certificate'), 'error');
        }
      } catch (err) {
        showAlert('❌ Error: ' + err.message, 'error');
      }
    }

    async function loadDashboard() {
      try {
        const certsRes = await fetch(`${API_BASE_URL}/certificates/admin/list`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const certs = await certsRes.json();

        const usersRes = await fetch(`${API_BASE_URL}/users/admin/users`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const users = await usersRes.json();

        // Update stats
        document.getElementById('totalCerts').textContent = certs.length;
        document.getElementById('activeCerts').textContent = certs.filter(c => c.status === 'active').length;
        document.getElementById('totalUsers').textContent = users.length;
        document.getElementById('revokedCerts').textContent = certs.filter(c => c.status === 'revoked').length;
      } catch (err) {
        console.error('Dashboard error:', err);
      }
    }

    async function loadCertificates() {
      document.getElementById('loader').classList.add('active');

      try {
        const response = await fetch(`${API_BASE_URL}/certificates/admin/list`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const certs = await response.json();

        let html = '';
        certs.forEach(cert => {
          const statusClass = cert.status === 'active' ? 'badge-success' : cert.status === 'revoked' ? 'badge-danger' : 'badge-warning';
          html += `
            <tr>
              <td>${cert.certificateNumber}</td>
              <td>${cert.fullName}</td>
              <td>${cert.courseName}</td>
              <td>${cert.issueDate}</td>
              <td><span class="badge ${statusClass}">${cert.status.toUpperCase()}</span></td>
              <td>
                <button onclick="viewCertificate('${cert.certificateNumber}')" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">View</button>
                ${cert.status === 'active' ? `<button onclick="openRevokeModal('${cert.certificateNumber}')" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;">Revoke</button>` : ''}
              </td>
            </tr>
          `;
        });

        document.getElementById('certificatesList').innerHTML = html || '<tr><td colspan="6" style="text-align: center;">No certificates found</td></tr>';
      } catch (err) {
        showAlert('Error loading certificates: ' + err.message, 'error');
      } finally {
        document.getElementById('loader').classList.remove('active');
      }
    }

    async function loadUsers() {
      document.getElementById('usersLoader').classList.add('active');

      try {
        const response = await fetch(`${API_BASE_URL}/users/admin/users`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const users = await response.json();

        let html = '';
        users.forEach(user => {
          html += `
            <tr>
              <td>${user.fullName}</td>
              <td>${user.email}</td>
              <td>${user.courseName || 'N/A'}</td>
              <td>${new Date(user.registrationDate).toLocaleDateString()}</td>
              <td><span class="badge badge-success">${user.isActive ? 'Active' : 'Inactive'}</span></td>
            </tr>
          `;
        });

        document.getElementById('usersList').innerHTML = html || '<tr><td colspan="5" style="text-align: center;">No users found</td></tr>';
      } catch (err) {
        showAlert('Error loading users: ' + err.message, 'error');
      } finally {
        document.getElementById('usersLoader').classList.remove('active');
      }
    }

    async function verifyCertificate() {
      const certNumber = document.getElementById('verifyCertNumber').value;

      if (!certNumber) {
        showAlert('Please enter certificate number', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/certificates/verify/${certNumber}`);
        const result = await response.json();

        let html = '';
        if (result.valid) {
          html = `
            <div style="background: #d4edda; padding: 20px; border-radius: 8px; margin-top: 20px;">
              <h3 style="color: #155724;"><i class="fas fa-check-circle"></i> Certificate Valid</h3>
              <p><strong>Name:</strong> ${result.certificate.fullName}</p>
              <p><strong>Course:</strong> ${result.certificate.courseName}</p>
              <p><strong>Certificate #:</strong> ${result.certificate.certificateNumber}</p>
              <p><strong>Issued:</strong> ${result.certificate.issueDate}</p>
              <p><strong>Status:</strong> <span class="badge badge-success">${result.certificate.status}</span></p>
            </div>
          `;
        } else {
          html = `
            <div style="background: #f8d7da; padding: 20px; border-radius: 8px; margin-top: 20px;">
              <h3 style="color: #721c24;"><i class="fas fa-times-circle"></i> Certificate ${result.status === 'revoked' ? 'Revoked' : 'Expired'}</h3>
              <p>${result.message}</p>
            </div>
          `;
        }

        document.getElementById('verifyResult').innerHTML = html;
      } catch (err) {
        showAlert('Error verifying certificate: ' + err.message, 'error');
      }
    }

    function openRevokeModal(certNumber) {
      currentCertToRevoke = certNumber;
      document.getElementById('revokeModal').classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    async function confirmRevoke() {
      const reason = document.getElementById('revokeReason').value;

      try {
        const response = await fetch(`${API_BASE_URL}/certificates/admin/revoke`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            certificateNumber: currentCertToRevoke,
            reason: reason
          })
        });

        if (response.ok) {
          showAlert('✅ Certificate revoked successfully', 'success');
          closeModal('revokeModal');
          loadCertificates();
        } else {
          showAlert('❌ Error revoking certificate', 'error');
        }
      } catch (err) {
        showAlert('Error: ' + err.message, 'error');
      }
    }

    function viewCertificate(certNumber) {
      window.open(`${API_BASE_URL.replace('/api', '')}/verify?cert=${certNumber}`, '_blank');
    }

    function logout() {
      localStorage.removeItem('adminToken');
      window.location.href = '/admin/login.php';
    }

    // Load dashboard on page load
    window.addEventListener('load', () => {
      loadDashboard();
    });
  </script>
</body>
</html>
